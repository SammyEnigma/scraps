project scraps ;

path-constant NEEDS_PATH : needs ;

rule clang-defaults ( properties * ) {
    local result ;
    if <toolset>darwin in $(properties) {
        result += <cflags>-Wbool-conversion ;
        result += <cflags>-Wconditional-uninitialized ;
        result += <cflags>-Wconstant-conversion ;
        result += <cflags>-Wduplicate-method-match ;
        result += <cflags>-Wenum-conversion ;
        result += <cflags>-Wint-conversion ;
        result += <cflags>-fdiagnostics-show-note-include-stack ;
        result += <cflags>-fmacro-backtrace-limit=0 ;
        result += <cflags>-Werror=deprecated-objc-isa-usage ;
        result += <cflags>-Werror=objc-root-class ;
        result += <cflags>-Wno-missing-prototypes ;
        result += <cflags>-Wno-selector ;
        result += <cflags>-Wno-strict-selector-match ;
        result += <cflags>-Wprotocol ;
        result += <cflags>-Wundeclared-selector ;
    }
    if <toolset>darwin in $(properties) || <toolset>clang in $(properties) {
        result += <cflags>-fmessage-length=0 ;
        result += <cflags>-fstrict-aliasing ;
        result += <cflags>-Wdeprecated-declarations ;
        result += <cflags>-Wempty-body ;
        result += <cflags>-Werror=return-type ;
        result += <cflags>-Winvalid-offsetof ;
        result += <cflags>-Wno-arc-repeated-use-of-weak ;
        result += <cflags>-Wno-c++11-extensions ;
        result += <cflags>-Wno-c++1y-extensions ;
        result += <cflags>-Wno-conversion ;
        result += <cflags>-Wno-deprecated-declarations ;
        result += <cflags>-Wno-deprecated-implementations ;
        result += <cflags>-Wno-exit-time-destructors ;
        result += <cflags>-Wno-four-char-constants ;
        result += <cflags>-Wno-implicit-atomic-properties ;
        result += <cflags>-Wno-missing-braces ;
        result += <cflags>-Wno-missing-field-initializers ;
        result += <cflags>-Wno-newline-eof ;
        result += <cflags>-Wno-non-virtual-dtor ;
        result += <cflags>-Wno-overloaded-virtual ;
        result += <cflags>-Wno-receiver-is-weak ;
        result += <cflags>-Wno-shadow ;
        result += <cflags>-Wno-sign-conversion ;
        result += <cflags>-Wno-unknown-pragmas ;
        result += <cflags>-Wno-unused-label ;
        result += <cflags>-Wno-unused-local-typedef ;
        result += <cflags>-Wno-unused-parameter ;
        result += <cflags>-Wparentheses ;
        result += <cflags>-Wswitch ;
        result += <cflags>-Wunreachable-code ;
        result += <cflags>-Wunused-function ;
        result += <cflags>-Wunused-value ;
        result += <cflags>-Wunused-variable ;
    }
    return $(result) ;
}

alias project_defaults : : : :
    <conditional>@clang-defaults

    <toolset>gcc:<cflags>-Wno-error=format
    <toolset>gcc:<cflags>-Wno-error=unused-variable
    <toolset>gcc:<cflags>-Wno-unused-variable
    <toolset>gcc:<cflags>-Wno-format
    <toolset>gcc:<cflags>-Wno-unused-local-typedefs
    <toolset>gcc:<cflags>-Wno-sign-compare

    <define>STATICLIB
;

alias objc : : : :
    <target-os>darwin:<cxxflags>"-x objective-c++"
    <target-os>iphone:<cxxflags>"-x objective-c++"
    <target-os>appletv:<cxxflags>"-x objective-c++"
    <target-os>darwin:<cflags>-fobjc-arc
    <target-os>iphone:<cflags>-fobjc-arc
    <target-os>appletv:<cflags>-fobjc-arc
;

lib ssl       : $(NEEDS_PATH)//openssl : <name>ssl ;
lib crypto    : $(NEEDS_PATH)//openssl : <name>crypto ;
alias openssl : ssl crypto ;

lib curl   : $(NEEDS_PATH)//curl : <name>curl ;
lib fmt    : $(NEEDS_PATH)//fmtlib : <name>fmt ;
lib sodium : $(NEEDS_PATH)//libsodium : <name>sodium ;
alias gsl  : $(NEEDS_PATH)//gsl ;

lib boost_system          : $(NEEDS_PATH)//boost : <name>boost_system ;
lib boost_filesystem      : $(NEEDS_PATH)//boost : <name>boost_filesystem ;
lib boost_program_options : $(NEEDS_PATH)//boost : <name>boost_program_options ;

alias mnmlstc : $(NEEDS_PATH)//mnmlstc ;

lib GLESv2 : : <link>shared ;
lib z : : <link>shared ;
lib dl : : <link>shared ;
lib pthread : : <link>shared ;

alias scraps_deps :
    openssl
    curl
    fmt
    sodium
    gsl
    boost_system
    boost_filesystem
    boost_program_options
    mnmlstc
    project_defaults
    objc
: : :
    <include>include
    <cxxflags>"-std=c++1y"

    <target-os>darwin:<framework>Foundation
    <target-os>darwin:<framework>CoreServices
    <target-os>darwin:<framework>CoreFoundation
    <target-os>darwin:<framework>Security

    <target-os>darwin:<framework>OpenGL
    <target-os>iphone:<framework>OpenGLES
    <target-os>appletv:<framework>OpenGLES
;

lib scraps :
    [ glob-tree-ex src : *.cpp ]
    scraps_deps
    mnmlstc
    z
:
    <link>static
    <target-os>android:<source>GLESv2
    <target-os>linux:<source>pthread
    <target-os>linux:<source>dl
;

import package ;

package.install install-lib : <install-source-root>include : : scraps : [ glob-tree-ex include : *.h ] ;

path-constant PREFIX : [ option.get prefix : "/usr/local" ] ;
path-constant LIB : [ option.get libdir : $(PREFIX)/lib ] ;
path-constant PKG_CONFIG : $(LIB)/pkgconfig ;

make scraps.pc : Jamroot : @pkgconfig ;
rule pkgconfig ( targets * : sources * : properties * ) {
    if <toolset>darwin in $(properties) {
        PRIVATE_LIBS on $(targets) = -framework Foundation ;
    }
}
actions pkgconfig {
cat > $(<) <<- EOM
prefix=\${pcfiledir}/../..
exec_prefix=\${prefix}
libdir=\${exec_prefix}/lib
includedir=\${exec_prefix}/include

Name: scraps
Version: 0
Description: Random scraps of C++
Requires: libcurl, openssl, fmt, boost_program_options, boost_system, boost_filesystem, gsl, libsodium, mnmlstc
Libs: -L\${libdir} -lscraps
Libs.private: $(PRIVATE_LIBS)
Cflags: -I\${includedir}
EOM
}

install install-pkgconfig : scraps.pc : <location>$(PKG_CONFIG) ;

alias install :
    install-lib
    install-pkgconfig
    $(NEEDS_PATH)//install-openssl
    $(NEEDS_PATH)//install-openssl
    $(NEEDS_PATH)//install-curl
    $(NEEDS_PATH)//install-fmtlib
    $(NEEDS_PATH)//install-libsodium
    $(NEEDS_PATH)//install-gsl
    $(NEEDS_PATH)//install-boost
    $(NEEDS_PATH)//install-boost
    $(NEEDS_PATH)//install-boost
    $(NEEDS_PATH)//install-mnmlstc
;

explicit install install-lib install-pkgconfig ;
