project scraps ;

path-constant NEEDS_PATH : needs ;

rule clang-defaults ( properties * ) {
    if <toolset>darwin in $(properties) || <toolset>clang in $(properties) {
        local result ;
        result += <cflags>-fdiagnostics-show-note-include-stack ;
        result += <cflags>-fmacro-backtrace-limit=0 ;
        result += <cflags>-fmessage-length=0 ;
        result += <cflags>-fmodules ;
        result += <cflags>-fstrict-aliasing ;
        result += <cflags>-Wbool-conversion ;
        result += <cflags>-Wconditional-uninitialized ;
        result += <cflags>-Wconstant-conversion ;
        result += <cflags>-Wdeprecated-declarations ;
        result += <cflags>-Wduplicate-method-match ;
        result += <cflags>-Wempty-body ;
        result += <cflags>-Wenum-conversion ;
        result += <cflags>-Werror=deprecated-objc-isa-usage ;
        result += <cflags>-Werror=objc-root-class ;
        result += <cflags>-Werror=return-type ;
        result += <cflags>-Wint-conversion ;
        result += <cflags>-Winvalid-offsetof ;
        result += <cflags>-Wno-arc-repeated-use-of-weak ;
        result += <cflags>-Wno-c++11-extensions ;
        result += <cflags>-Wno-c++1y-extensions ;
        result += <cflags>-Wno-conversion ;
        result += <cflags>-Wno-deprecated-declarations ;
        result += <cflags>-Wno-deprecated-implementations ;
        result += <cflags>-Wno-exit-time-destructors ;
        result += <cflags>-Wno-four-char-constants ;
        result += <cflags>-Wno-implicit-atomic-properties ;
        result += <cflags>-Wno-missing-braces ;
        result += <cflags>-Wno-missing-field-initializers ;
        result += <cflags>-Wno-missing-prototypes ;
        result += <cflags>-Wno-newline-eof ;
        result += <cflags>-Wno-non-virtual-dtor ;
        result += <cflags>-Wno-overloaded-virtual ;
        result += <cflags>-Wno-receiver-is-weak ;
        result += <cflags>-Wno-selector ;
        result += <cflags>-Wno-shadow ;
        result += <cflags>-Wno-sign-conversion ;
        result += <cflags>-Wno-strict-selector-match ;
        result += <cflags>-Wno-unknown-pragmas ;
        result += <cflags>-Wno-unused-label ;
        result += <cflags>-Wno-unused-local-typedef ;
        result += <cflags>-Wno-unused-parameter ;
        result += <cflags>-Wparentheses ;
        result += <cflags>-Wprotocol ;
        result += <cflags>-Wswitch ;
        result += <cflags>-Wundeclared-selector ;
        result += <cflags>-Wunreachable-code ;
        result += <cflags>-Wunused-function ;
        result += <cflags>-Wunused-value ;
        result += <cflags>-Wunused-variable ;
        return $(result) ;
    }
}

alias project_defaults : : : :
    <conditional>@clang-defaults

    <toolset>gcc:<cflags>-Wno-error=format
    <toolset>gcc:<cflags>-Wno-error=unused-variable
    <toolset>gcc:<cflags>-Wno-unused-variable
    <toolset>gcc:<cflags>-Wno-format
    <toolset>gcc:<cflags>-Wno-unused-local-typedefs
    <toolset>gcc:<cflags>-Wno-sign-compare

    <define>STATICLIB
    <cflags>-U__STRICT_ANSI__
;


alias objc : : : :
    <toolset>darwin:<cxxflags>"-x objective-c++"
    <toolset>darwin:<cflags>-fobjc-arc
;

lib ssl       : $(NEEDS_PATH)//openssl : <name>ssl ;
lib crypto    : $(NEEDS_PATH)//openssl : <name>crypto ;
alias openssl : ssl crypto ;

lib curl   : $(NEEDS_PATH)//curl : <name>curl ;
lib fmt    : $(NEEDS_PATH)//fmtlib : <name>fmt ;
lib sodium : $(NEEDS_PATH)//libsodium : <name>sodium ;
alias gsl  : $(NEEDS_PATH)//gsl ;

lib boost_system          : $(NEEDS_PATH)//boost : <name>boost_system ;
lib boost_filesystem      : $(NEEDS_PATH)//boost : <name>boost_filesystem ;
lib boost_program_options : $(NEEDS_PATH)//boost : <name>boost_program_options ;

alias mnmlstc : $(NEEDS_PATH)//mnmlstc ;

alias scraps_headers :
    openssl
    curl
    fmt
    sodium
    gsl
    boost_system
    boost_filesystem
    boost_program_options
    mnmlstc
    project_defaults
:
    <include>include
: :
    <include>include
;

lib libGLESv2 : : <name>GLESv2 <link>shared ;
lib z : : <name>z ;

lib scraps :
    objc
    [ glob-tree-ex src : *.cpp ]
    scraps_headers
    mnmlstc
    z
:
    <link>static
    <cxxflags>"-std=c++14"
    <target-os>android:<source>libGLESv2
: :
    <target-os>darwin:<framework>Foundation
    <target-os>darwin:<framework>CoreServices
    <target-os>darwin:<framework>CoreFoundation
    <target-os>darwin:<framework>Security

    <target-os>darwin:<framework>OpenGL
    <target-os>iphone:<framework>OpenGLES
    <target-os>appletv:<framework>OpenGLES

    <target-os>linux:<linkflags>"-lpthread -ldl"

    <cxxflags>"-std=c++14"
;

import package ;
package.install install : <install-source-root>include : : scraps : [ glob-tree-ex include : *.h ] ;
explicit install ;
